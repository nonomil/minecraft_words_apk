<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS 调试工具</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .test-section h3 {
            margin-top: 0;
            color: #FFD700;
        }
        button {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        button:active {
            transform: translateY(0);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .status.success { background: rgba(76, 175, 80, 0.3); border: 1px solid #4CAF50; }
        .status.error { background: rgba(244, 67, 54, 0.3); border: 1px solid #F44336; }
        .status.warning { background: rgba(255, 152, 0, 0.3); border: 1px solid #FF9800; }
        .status.info { background: rgba(33, 150, 243, 0.3); border: 1px solid #2196F3; }
        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }
        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 TTS 调试工具</h1>
        
        <div class="test-section">
            <h3>📊 环境检测</h3>
            <div id="envStatus" class="status info">检测中...</div>
            <button onclick="detectEnvironment()">🔍 重新检测环境</button>
        </div>

        <div class="test-section">
            <h3>🗣️ 基础语音测试</h3>
            <button onclick="testWebSpeech()">🌐 测试 Web Speech API</button>
            <button onclick="testCapacitorTTS()">📱 测试 Capacitor TTS</button>
            <button onclick="testGameTTS()">🎮 测试游戏 TTS 适配器</button>
        </div>

        <div class="test-section">
            <h3>🎯 自定义测试</h3>
            <input type="text" id="customText" placeholder="输入要测试的文本" value="Hello World 你好世界">
            <br>
            <button onclick="speakCustom('en-US')">🇺🇸 英文发音</button>
            <button onclick="speakCustom('zh-CN')">🇨🇳 中文发音</button>
            <button onclick="stopSpeech()">⏹️ 停止语音</button>
        </div>

        <div class="test-section">
            <h3>📝 调试日志</h3>
            <button onclick="clearLog()">🗑️ 清空日志</button>
            <div id="debugLog" class="log">等待测试...
</div>
        </div>
    </div>

    <script>
        let logElement = document.getElementById('debugLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'info': 'ℹ️',
                'success': '✅',
                'error': '❌',
                'warning': '⚠️'
            }[type] || 'ℹ️';
            
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[TTS Debug] ${message}`);
        }
        
        function clearLog() {
            logElement.textContent = '日志已清空\n';
        }
        
        function detectEnvironment() {
            const statusEl = document.getElementById('envStatus');
            let status = [];
            
            // 检测 Web Speech API
            if ('speechSynthesis' in window) {
                status.push('✅ Web Speech API 可用');
                log('Web Speech API 检测成功', 'success');
            } else {
                status.push('❌ Web Speech API 不可用');
                log('Web Speech API 不可用', 'error');
            }
            
            // 检测 Capacitor
            if (window.Capacitor) {
                status.push('✅ Capacitor 环境检测到');
                log(`Capacitor 版本: ${window.Capacitor.getPlatform ? window.Capacitor.getPlatform() : '未知'}`, 'success');
                
                if (window.Capacitor.Plugins && window.Capacitor.Plugins.TextToSpeech) {
                    status.push('✅ TextToSpeech 插件可用');
                    log('Capacitor TextToSpeech 插件检测成功', 'success');
                } else {
                    status.push('⚠️ TextToSpeech 插件未找到');
                    log('Capacitor TextToSpeech 插件未找到', 'warning');
                }
            } else {
                status.push('⚠️ Capacitor 环境未检测到');
                log('当前为浏览器环境，非 Capacitor 原生环境', 'warning');
            }
            
            // 检测游戏 TTS 适配器
            if (window.TTS) {
                status.push('✅ 游戏 TTS 适配器可用');
                log('游戏 TTS 适配器检测成功', 'success');
            } else {
                status.push('❌ 游戏 TTS 适配器未加载');
                log('游戏 TTS 适配器未找到', 'error');
            }
            
            statusEl.innerHTML = status.join('<br>');
            statusEl.className = 'status ' + (status.some(s => s.includes('❌')) ? 'error' : 'success');
        }
        
        function testWebSpeech() {
            log('开始测试 Web Speech API...', 'info');
            
            if (!('speechSynthesis' in window)) {
                log('Web Speech API 不可用', 'error');
                return;
            }
            
            try {
                const utterance = new SpeechSynthesisUtterance('Web Speech API 测试成功');
                utterance.lang = 'zh-CN';
                utterance.rate = 1;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                utterance.onstart = () => log('Web Speech 开始播放', 'success');
                utterance.onend = () => log('Web Speech 播放完成', 'success');
                utterance.onerror = (e) => log(`Web Speech 错误: ${e.error}`, 'error');
                
                speechSynthesis.speak(utterance);
                log('Web Speech API 调用成功', 'success');
            } catch (error) {
                log(`Web Speech API 测试失败: ${error.message}`, 'error');
            }
        }
        
        function testCapacitorTTS() {
            log('开始测试 Capacitor TTS...', 'info');
            
            if (!window.Capacitor || !window.Capacitor.Plugins || !window.Capacitor.Plugins.TextToSpeech) {
                log('Capacitor TextToSpeech 插件不可用', 'error');
                return;
            }
            
            try {
                const tts = window.Capacitor.Plugins.TextToSpeech;
                tts.speak({
                    text: 'Capacitor TTS 测试成功',
                    lang: 'zh-CN',
                    rate: 1.0,
                    pitch: 1.0,
                    volume: 1.0
                }).then(() => {
                    log('Capacitor TTS 播放成功', 'success');
                }).catch((error) => {
                    log(`Capacitor TTS 播放失败: ${error}`, 'error');
                });
                
                log('Capacitor TTS 调用成功', 'success');
            } catch (error) {
                log(`Capacitor TTS 测试失败: ${error.message}`, 'error');
            }
        }
        
        function testGameTTS() {
            log('开始测试游戏 TTS 适配器...', 'info');
            
            if (!window.TTS) {
                log('游戏 TTS 适配器不可用', 'error');
                return;
            }
            
            try {
                // 先启用 TTS
                window.TTS.enable().then(() => {
                    log('TTS 适配器启用成功', 'success');
                    
                    // 测试中文
                    return window.TTS.speak('游戏 TTS 适配器测试成功', {
                        lang: 'zh-CN',
                        rate: 1.0,
                        pitch: 1.0,
                        volume: 1.0
                    });
                }).then((result) => {
                    log(`游戏 TTS 中文测试结果: ${result}`, result ? 'success' : 'error');
                    
                    // 测试英文
                    return window.TTS.speak('Game TTS adapter test successful', {
                        lang: 'en-US',
                        rate: 1.0,
                        pitch: 1.0,
                        volume: 1.0
                    });
                }).then((result) => {
                    log(`游戏 TTS 英文测试结果: ${result}`, result ? 'success' : 'error');
                }).catch((error) => {
                    log(`游戏 TTS 测试失败: ${error}`, 'error');
                });
            } catch (error) {
                log(`游戏 TTS 适配器测试失败: ${error.message}`, 'error');
            }
        }
        
        function speakCustom(lang) {
            const text = document.getElementById('customText').value.trim();
            if (!text) {
                log('请输入要测试的文本', 'warning');
                return;
            }
            
            log(`开始播放自定义文本 (${lang}): ${text}`, 'info');
            
            // 优先使用游戏 TTS 适配器
            if (window.TTS) {
                window.TTS.speak(text, {
                    lang: lang,
                    rate: 1.0,
                    pitch: 1.0,
                    volume: 1.0
                }).then((result) => {
                    log(`自定义文本播放结果: ${result}`, result ? 'success' : 'error');
                }).catch((error) => {
                    log(`自定义文本播放失败: ${error}`, 'error');
                });
            } else if ('speechSynthesis' in window) {
                // 回退到 Web Speech API
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                utterance.onstart = () => log('开始播放自定义文本', 'success');
                utterance.onend = () => log('自定义文本播放完成', 'success');
                utterance.onerror = (e) => log(`自定义文本播放错误: ${e.error}`, 'error');
                speechSynthesis.speak(utterance);
            } else {
                log('没有可用的 TTS 引擎', 'error');
            }
        }
        
        function stopSpeech() {
            log('停止所有语音播放', 'info');
            
            // 停止游戏 TTS
            if (window.TTS) {
                window.TTS.cancel();
            }
            
            // 停止 Web Speech
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
            
            // 停止 Capacitor TTS
            if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.TextToSpeech) {
                window.Capacitor.Plugins.TextToSpeech.stop();
            }
            
            log('语音播放已停止', 'success');
        }
        
        // 页面加载完成后自动检测环境
        window.addEventListener('load', () => {
            log('TTS 调试工具已加载', 'success');
            detectEnvironment();
        });
        
        // 加载游戏的 TTS 适配器（如果存在）
        const script = document.createElement('script');
        script.src = './js/tts-adapter.js';
        script.onload = () => {
            log('游戏 TTS 适配器已加载', 'success');
            detectEnvironment();
        };
        script.onerror = () => {
            log('游戏 TTS 适配器加载失败', 'warning');
        };
        document.head.appendChild(script);
    </script>
</body>
</html>